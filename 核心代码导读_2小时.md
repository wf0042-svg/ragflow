# RAGFlow 核心代码导读（约 2 小时）

面向「不熟 Python、要做二次开发、想快速定位问题」的读者。按下面顺序看，能建立「请求 → API → 服务 → RAG/文档处理」的完整心智模型。

---

## 一、整体思路：先抓「入口 + 三条主链路」

- **入口**：所有 HTTP 请求从哪里进来、怎么路由。
- **三条主链路**（按你关心的功能选 1～2 条重点看）：
  1. **文档解析与入库**：上传 → 解析 → 分块 → 写入检索库。
  2. **对话/检索回答**：提问 → 检索 → 拼 prompt → 调用 LLM → 流式返回。
  3. **知识库/数据集管理**：创建 KB、管理文档、任务状态。

每条链路都遵循：**API（apps）→ Service（db/services）→ 具体实现（rag / deepdoc 等）**。

---

## 二、约 2 小时的阅读顺序

### 第 1 步：入口与路由（约 15 分钟）

| 文件 | 看什么 |
|------|--------|
| `api/ragflow_server.py` | Flask 应用创建、如何挂载各 blueprint、中间件。 |
| `api/apps/__init__.py` 或各 `*_app.py` 开头的注册 | 哪个 URL 前缀对应哪个 app（如 `/api/kb`、`/api/document`）。 |

**目标**：知道「前端的某个功能」对应到哪个 `*_app.py`，方便以后按功能搜接口再追代码。

---

### 第 2 步：选一条主链路深入（约 45～60 分钟）

按你最常改的功能选一条即可。

#### 链路 A：文档解析与入库（适合做解析、分块、索引）

| 顺序 | 文件 | 看什么 |
|------|------|--------|
| 1 | `api/apps/document_app.py` | 文档上传、解析、创建任务的 API（可搜 `upload`、`parse`、`create` 等）。 |
| 2 | `api/db/services/document_service.py` | 文档业务逻辑：调谁做解析、怎么建任务、写哪里。 |
| 3 | `rag/svr/task_executor.py` | 异步任务执行：真正触发解析/分块/入库的地方。 |
| 4 | `rag/flow/` | 管道：`parser` → `splitter` → `tokenizer` 等，理解「从文件到 chunk」的流程。 |
| 5 | `deepdoc/parser/` | 具体解析器（如 PDF、docx、excel），按你关心的格式选一个看。 |

**定位技巧**：在 `document_app.py` 里找到接口路径 → 搜对应的 service 方法名 → 再搜该方法在 `rag/`、`deepdoc/` 的调用。

#### 链路 B：对话/检索回答（适合做检索、prompt、流式输出）

| 顺序 | 文件 | 看什么 |
|------|------|--------|
| 1 | `api/apps/dialog_app.py` 或 `api/apps/sdk/chat.py` | 对话/聊天 API：请求体、流式响应。 |
| 2 | `api/db/services/dialog_service.py` | 组装检索、调用 LLM、写会话与消息。 |
| 3 | `rag/nlp/search.py` 或 `rag/advanced_rag/` | 检索实现（向量检索、关键词、混合等）。 |
| 4 | `rag/llm/chat_model.py` | 如何调 LLM、流式返回。 |
| 5 | `rag/prompts/` | 各类 prompt 模板（.md），便于改话术或逻辑。 |

**定位技巧**：从「发一条对话请求」的 API 开始，沿 `dialog_service` → `search` / `chat_model` 往下追。

#### 链路 C：知识库与任务管理（适合做权限、状态、任务）

| 顺序 | 文件 | 看什么 |
|------|------|--------|
| 1 | `api/apps/kb_app.py` | 知识库 CRUD、列表、设置等 API。 |
| 2 | `api/db/services/knowledgebase_service.py` | 知识库与数据集逻辑。 |
| 3 | `api/db/services/task_service.py` | 任务状态、进度、失败重试。 |
| 4 | `api/db/db_models.py` | 表结构：KB、Document、Chunk、Task 等，便于理解数据流。 |

---

### 第 3 步：数据与配置（约 20 分钟）

| 文件 | 看什么 |
|------|--------|
| `api/db/db_models.py` | 主要表：User、KB、Document、Chunk、Dialog、Message、Task。 |
| `api/settings.py`、`rag/settings.py` | 配置项从哪里来（环境变量、配置文件）。 |
| `docker/service_conf.yaml.template` 或 `docker/.env` | 部署时的配置入口。 |

---

### 第 4 步：按问题反查（剩余时间）

- 出错/日志里出现 **文件名/类名/函数名** → 在项目里全局搜该名字。
- 想改 **某个 API 的行为** → 在 `docs/references/http_api_reference.md` 里搜接口路径，再在 `api/apps/` 里搜路径或关键词。
- 想改 **解析/分块/检索策略** → 在 `rag/flow/`、`deepdoc/`、`rag/nlp/` 里搜相关词（如 `chunk`、`split`、`retrieve`）。

---

## 三、代码没有注释怎么办？

RAGFlow 代码注释确实很少，可以用下面几种方式补足：

### 1. 用 Cursor / AI 辅助「边看边问」

- 对某个文件或函数**选中代码 → 问**：「这段在做什么？和 XXX 的关系是什么？」
- 问「调用链」：例如「从 `document_app` 上传接口到真正执行解析，经过了哪些函数？」
- 这样相当于「按需生成注释」，不必一次性给全项目加注释。

### 2. 先看 HTTP API 文档再反追代码

- `docs/references/http_api_reference.md` 里写了接口路径、请求/响应体。
- 先确定「要改的是哪个接口」，再在 `api/apps/` 里搜路径或关键词，找到对应 view → 再追到 service → rag/deepdoc。这样即使用语不熟，也能靠「接口名 + 参数」理解在干什么。

### 3. 用「调用关系」代替注释

- 在 IDE 里对关键函数用「查找引用」：看谁在调它、它调了谁。
- 重点看：**API 层 → Service 层 → rag/ deepdoc**，这三层捋清楚，大部分问题都能定位到具体文件甚至函数。

### 4. 只给「自己要改的模块」加注释

- 不必给整个项目补注释；只在你常改的 1～2 个模块里，给关键函数、复杂分支写 1～2 行中文注释（做什么、和谁配合），方便以后自己维护。

---

## 四、快速对照表：功能 → 可能涉及的文件

| 你想改/排查的问题 | 优先看的目录/文件 |
|-------------------|--------------------|
| 文档解析失败、格式不支持 | `deepdoc/parser/`、`rag/flow/parser/`、`rag/svr/task_executor.py` |
| 分块不对、chunk 太大太小 | `rag/flow/splitter/`、`rag/app/`（不同 doc 类型策略） |
| 检索不准、想改检索策略 | `rag/nlp/search.py`、`rag/advanced_rag/`、`api/db/services/dialog_service.py` |
| 对话回复不对、想改 prompt | `rag/prompts/`、`rag/llm/chat_model.py`、`dialog_service` |
| 上传/任务状态/进度 | `api/apps/document_app.py`、`document_service`、`task_service`、`task_executor` |
| 知识库/权限/多租户 | `api/apps/kb_app.py`、`knowledgebase_service`、`api/db/db_models.py` |

---

按上述顺序花约 2 小时走一遍，你就能在后续二次开发时快速定位到「问题大概在哪一层、哪个文件」，再结合 Cursor 追问具体实现细节即可。若你告诉我主要想改「解析」「检索」还是「对话」，我可以按其中一条链路把具体函数名和调用关系再列细一点。
